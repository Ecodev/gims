<div class="container" >
    <!-- Toolbar -->
    <div class='navbar navbar-default hidden-print'>
        <form class='navbar-form'>
            <!-- Back button, if return url is specified -->
            <button class='btn btn-default' ng-show='returnUrl' ng-click='cancel();'><i class='fa fa-gims-back'></i> Cancel</button>
            <!-- Save all the new questionniares -->
            <button class='btn btn-primary' ng-show='isEmptyQuestionnaires() || isEmptyFilters()' ng-click='saveQuestionnaires();' ng-disabled='isLoading || !tabs.filters && !tabs.questionnaires'><i class='fa fa-asterisk'></i> Save all new elements</button>
            <!-- Clear the selection -->
            <a href class='btn btn-default' ng-click='tabs.questionnaires=[];tabs.filters=[];tabs.filterSet=null;tabs.country=null;tabs.filter=null;tabs.survey=null'><i class='fa fa-eraser'></i> Clear selection</a>
            <!-- Hide/Show selection tools and/or children filters -->
            <div class='btn-group'>
                <button class='btn btn-default' ng-click='expandHierarchy = !expandHierarchy'><i class='fa' ng-class="{'fa-compress text-primary':expandHierarchy,'fa-expand':!expandHierarchy}"></i> Hierarchy tree</button>
                <button class="btn btn-default" ng-click='expandSelection = !expandSelection'><i class='fa' ng-class="{'fa-compress':expandSelection,'fa-expand text-primary':!expandSelection}"></i> Selection</button>
            </div>
            <!-- Switch navigation mode Browse/Contribute -->
            <button ng-click='nextMode()' class='btn btn-default' ><i class='fa fa-eye'></i> {{mode}}</button>

            <!-- Loading indicator -->
            <i class="pull-right fa fa-gims-loading fa-2x" ng-show="isLoading" style='margin-top:5px'></i>
        </form>
    </div>

    <!-- Selection panel for filters and questionnaires -->
    <form name='selectionForm'>
        <div class="row show-grid ng-trans ng-trans-slide-up" ng-show="expandSelection" >

            <!-- Questionnaires selection -->
            <div class='col-md-6'>
                <div class='row' ng-class="{'has-error':!tabs.questionnaires.length && mode == 'Browse'}">

                    <div ng-show='sector'>
                        <div class='col-md-12'>
                            <h3 class='control-label'>Creation mode</h3>
                            <p>In this page you will be able to add custom data. You can create filters, questionnaires and then add answers and comments to them. When they are created, take care to not create them again. Use instead <a href='/contribute/questionnaire?returnUrl={{currentUrl}}'>questionnaires edition page</a> or <a href='/admin/filter'>filters management page</a>.<p>
                            <p>First of all select a root filter in the right panel or create a new one. For each child filter of the selected one, some sub-children will be created. Then the result of <i>"child1 * child2 / country population"</i> will be assigned to their parent.</p>
                        </div>
                    </div>

                    <div ng-hide='sector'>
                        <div class='col-md-12'>
                            <h3 class='control-label'>Surveys selection <small ng-show='!tabs.questionnaires.length && mode == "Browse"'>(Required)</small></h3>
                        </div>

                        <div class='col-md-12'>
                            <tabset>
                                <tab heading="Selected">
                                    <gims-select
                                        model="tabs.questionnaires"
                                        name='questionnaires'
                                        api="questionnaire"
                                        queryparams="questionnaireParams"
                                        placeholder="Select questionnaires"
                                        disabled='isLoading'
                                        multiple
                                        style="width: 100%">
                                    </gims-select>
                                </tab>
                                <tab ng-show='tabs.glass.length'>
                                    <tab-heading><span class='text-warning'><i class='fa fa-exclamation-triangle' ></i> Others</span></tab-heading>
                                    <p>Some selected surveys are only available in advanced edition mode and one at a time.</p>
                                    <p>Click to edit.</p>
                                    <ul class='list-unstyled'>
                                        <li ng-repeat='q in tabs.glass'><a href='/contribute/questionnaire/glass/{{q.id}}?returnUrl={{currentUrl}}'><i class='fa fa-external-link'></i> {{q.name}}</a></li>
                                    </ul>
                                </tab>
                                <tab heading="By survey">
                                    <gims-select
                                        model="tabs.survey"
                                        api="survey"
                                        queryparams="surveyParams"
                                        placeholder="Select survey"
                                        search-attributes='code,name'
                                        custom-selection-template="{{surveysTemplate}}"
                                        custom-result-template="{{surveysTemplate}}"
                                        change-url = "false"
                                        disabled='isLoading'
                                        style="width: 100%">
                                    </gims-select>
                                </tab>
                                <tab heading="By country">
                                    <gims-select
                                        model="tabs.country"
                                        api="country"
                                        queryparams="countryParams"
                                        placeholder="Select a country"
                                        change-url = "false"
                                        disabled='isLoading'
                                        style="width: 100%">
                                    </gims-select>
                                </tab>
                            </tabset>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter selection -->
            <div class="col-md-6" ng-show='(tabs.questionnaires.length || mode != "Browse") && !sector'>
                <div class='row' ng-class="{'has-error':!tabs.filters.length}">
                    <div class='col-md-12'>
                        <h3 class='control-label'>Filter selection <small ng-show='!tabs.filters.length'>(Required)</small></h3>
                    </div>

                    <div class='col-md-12'>
                        <tabset>
                            <tab heading="Selection">
                                <gims-select
                                    model="tabs.filters"
                                    name="filters"
                                    api="filter"
                                    queryparams="filterParams"
                                    placeholder="Select filters"
                                    container-css-class='select2list'
                                    current-context-element='?returnUrl={{currentUrl}}'
                                    custom-selection-template="{{filtersTemplate}}"
                                    custom-result-template="{{filtersTemplate}}"
                                    multiple
                                    disabled='isLoading'
                                    style="width: 100%">
                                </gims-select>
                            </tab>
                            <tab heading="By filter set">
                                <gims-select
                                    model="tabs.filterSet"
                                    api="filterSet"
                                    queryparams="filterSetParams"
                                    placeholder="Select filter set"
                                    change-url = "false"
                                    disabled='isLoading'
                                    style="width: 100%">
                                </gims-select>
                            </tab>
                            <tab heading="By filter's children">
                                <gims-select
                                    model="tabs.filter"
                                    api="filter"
                                    queryparams="filterParams"
                                    placeholder="Select filter"
                                    container-css-class='select2list'
                                    current-context-element='?returnUrl={{currentUrl}}'
                                    custom-selection-template="{{filtersTemplate}}"
                                    custom-result-template="{{filtersTemplate}}"
                                    change-url = "false"
                                    disabled='isLoading'
                                    style="width: 100%">
                                </gims-select>
                            </tab>
                        </tabset>
                    </div>
                </div>
            </div>

            <!-- Filter selection -->
            <div class="col-md-6" ng-show='sector'>
                <div class='row'>
                    <div class='col-md-12' ng-class="{'has-error':!tabs.filter.length}">
                        <h3 class='control-label'>Filter selection <small ng-show='!tabs.filter.length'>(Required)</small></h3>
                    </div>

                    <div class='col-md-12'>
                        <tabset>
                            <tab heading='Create sector filter set and root filter' active='tabs.create' disabled='tabs.createDisabled'>
                                <ng-form ng-class="{'has-error':filterSetForm.filterSet.$invalid}" name='filterSetForm'>
                                    <div class='row'>
                                        <div class='col-md-12'>
                                            <label class='control-label' for='filterSet'>Filter set name</label>
                                        </div>
                                    </div>
                                    <div class='row'>
                                        <div class='col-md-9'>
                                            <p class='form-group'>
                                                <input type='text' id='filterSet' name='filterSet' ng-model='tabs.newFilterSet.name' ng-required='!tabs.filter' placeholder='E.g : Bangladesh sector'/>
                                            </p>
                                        </div>
                                        <div class='col-md-2'>
                                            <button class='btn btn-primary' ng-click='createFilterSet()' ng-disabled="filterSetForm.filterSet.$invalid"><i class='fa fa-save'></i> Create</button>
                                        </div>
                                    </div>
                                </ng-form>
                            </tab>
                            <tab heading="Selected filter" active='tabs.view' disabled='tabs.viewDisabled'>
                                <gims-select
                                    model="tabs.filter"
                                    api="filter"
                                    queryparams="filterParams"
                                    placeholder="Select filter"
                                    container-css-class='select2list'
                                    current-context-element='?returnUrl={{currentUrl}}'
                                    custom-selection-template="{{filtersTemplate}}"
                                    custom-result-template="{{filtersTemplate}}"
                                    change-url = "false"
                                    disabled='isLoading'
                                    style="width: 100%">
                                </gims-select>
                            </tab>

                        </tabset>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Tabs parts -->
    <tabset class="nav-tabs-centered" ng-show='tabs.filters.length && (tabs.questionnaires.length || mode != "Browse")'>
        <tab ng-repeat='part in parts' heading="{{part.name}}" select='tabs.part = part'></tab>
    </tabset>

</div>


<!-- Table of filters, questionnaires and answers. Display in full width when there are too much elements -->
<div ng-hide='sector && !tabs.filter' class='tableContainer container' ng-class="{'gims-full-width-container': tabs.selectedQuestionnaireForLabels && tabs.questionnaires.length >= 3 || tabs.questionnaires.length >= 6 }">

    <div class='row'>
        <div class='col-md-12'>
            <form name='answersForm' novalidate>
                <table class='table table-bordered table-condensed bigtable'>

                    <!-- Head part : including country, survey code and survey year -->
                    <tbody>

                        <!-- Action buttons (first row) -->
                        <tr>
                            <td style='width:35px'></td>

                            <!-- Add a new empty questionnaire -->
                            <td style='width:350px'>
                                <a class='btn btn-default btn-xs'
                                   ng-click='addFilter();'
                                   ng-show='mode != "Browse" && sector'
                                   ng-class="{'disabled':!tabs.filter.id}">
                                    <i class='fa fa-plus'></i> Add new filter
                                </a>
                                <a class='btn btn-default btn-xs'
                                   ng-click='addQuestionnaire();'
                                   ng-show='mode != "Browse"'>
                                    <i class='fa fa-plus'></i> Add new survey
                                </a>
                            </td>

                            <!-- Label for question labels and close btn -->
                            <td style='width:350px' ng-if='tabs.selectedQuestionnaireForLabels' class='text-center'>
                                <i class='fa fa-question'></i>
                                Questions for
                                <a class='btn btn-default btn-xs pull-right' ng-click='tabs.selectedQuestionnaireForLabels = null'><i class='fa fa-times'></i></a>
                            </td>

                            <td ng-repeat='questionnaire in tabs.questionnaires track by $index'>

                                <!-- Display errors on questionnaires / surveys integrity data structure (like two different years for the same survey or two countries for the same survey -->
                                <a class='btn btn-warning btn-xs' ng-show='questionnaire.errors.duplicateCountryCode' tooltip='Surveys may not have the same country more than once' tooltip-placement='left'><i class='fa fa-warning'></i></a>
                                <a class='btn btn-warning btn-xs' ng-show='questionnaire.errors.codeAndYearDifferent' tooltip='Surveys with the same code may have the same year' tooltip-placement='left'><i class='fa fa-warning'></i></a>
                                <a class='btn btn-warning btn-xs' ng-show='questionnaire.errors.countryAlreadyUsedForExistingSurvey' tooltip='This country is already assigned to a survey with the same code' tooltip-placement='left'><i class='fa fa-warning'></i></a>
                                <a class='btn btn-warning btn-xs' ng-show='questionnaire.errors.surveyxistWithDifferentYear' tooltip='This survey already exists with different year : {{questionnaire.survey.existingYear}}' tooltip-placement='left'><i class='fa fa-warning'></i></a>
                                <a class='btn btn-warning btn-xs' ng-show='sector && questionnaire.id' tooltip="Can't edit existing survey in sector creation mode" tooltip-placement='left'><i class='fa fa-warning'></i></a>

                                <!-- mark new questionnaire / is loading -->
                                <a class='btn btn-xs' ng-show="!questionnaire.id || questionnaire.isLoading" tooltip='New survey' tooltip-placement='left' ><i class='fa fa-lg' ng-class="{'fa-asterisk':!questionnaire.isLoading, 'fa-gims-loading':questionnaire.isLoading}"></i></a>


                                <div class="btn-group pull-right">
                                    <button type="button" class="btn btn-default dropdown-toggle btn-xs" data-toggle="dropdown">
                                        <i class='fa fa-angle-down'></i>
                                    </button>
                                    <ul class="dropdown-menu pull-right" role="menu">

                                        <!-- Save a single questionnaire -->
                                        <li>
                                            <a ng-click='saveQuestionnaires($index)'
                                               ng-show='mode != "Browse" && !questionnaire.id'
                                               ng-class="{'disabled' : !checkIfSavableQuestionnaire(questionnaire)}" href>
                                                <span class='text-primary'><i class='fa fa-fw fa-save'></i> Save this survey</span>
                                            </a>
                                        </li>

                                        <li><a href ng-click='removeQuestionnaire($index)'><i class='fa fa-times fa-fw'></i> Remove survey from table</a></li>

                                        <li class="divider"></li>

                                        <!-- Questions labels edition button, display an additionnal column -->
                                        <li>
                                            <a ng-click='tabs.selectedQuestionnaireForLabels = questionnaire;' href>
                                                <i class='fa fa-question fa-fw'></i>
                                                Edit question labels
                                            </a>
                                        </li>

                                        <!-- Edit questionnaire comment, display an additionnal column -->
                                        <li>
                                            <a ng-click='tabs.selectedQuestionnaireForComments = questionnaire;' href>
                                                <i class='fa fa-comment fa-fw'></i>
                                                Edit survey comments
                                            </a>
                                        </li>

                                        <li ng-show='questionnairesWithUsages.length && !questionnaire.filterQuestionnaireUsages' class="divider"></li>

                                        <!-- Duplicate rules -->
                                        <li ng-if='q.id && (!questionnaire.filterQuestionnaireUsages || !questionnaire.filterQuestionnaireUsages.length)' class="dropdown-header"><i class='fa fa-cog fa-fw fa-lg'></i> Suggested formulas</li>
                                        <li ng-repeat='q in questionnairesWithUsages'
                                            ng-if='q.id && (!questionnaire.filterQuestionnaireUsages || !questionnaire.filterQuestionnaireUsages.length)'
                                            ng-attr-tooltip="{{!questionnaire.id && 'When the survey is saved, click here to report the same formulas'}}"
                                            tooltip-placement='left'>
                                            <a href ng-click='copyFilterUsages(questionnaire, q)'><i class='fa fa-gims-questionnaire fa-fw' ng-class="{'disabled':!questionnaire.id}"></i> {{q.geoname.country.name}} - {{q.survey.name}}</a>
                                        </li>


                                        <li ng-show='mode != "Browse" && questionnaire.id' class="divider"></li>

                                        <!-- Links to admin -->
                                        <li ng-show='mode != "Browse" && questionnaire.id' class="dropdown-header">
                                            <i class='fa fa-external-link fa-fw fa-lg'></i> Links to admin section
                                        </li>

                                        <li ng-show='mode != "Browse" && questionnaire.id'>
                                            <a  href='/admin/questionnaire/edit/{{questionnaire.id}}?returnUrl={{currentUrl}}'>
                                                <i class='fa fa-gims-survey fa-fw'></i>
                                                Edit Survey
                                            </a>
                                        </li>

                                        <!-- Link to questionnaire in /admin/ section -->
                                        <li  ng-show='mode != "Browse" && questionnaire.survey.id'>
                                            <a href='/admin/survey/edit/{{questionnaire.survey.id}}?returnUrl={{currentUrl}}'>
                                                <i class='fa fa-gims-questionnaire fa-fw'></i>
                                                Edit Questionnnaire
                                            </a>
                                        </li>


                                    </ul>
                                </div>
                            </td>
                        </tr>

                        <!-- Questionnaire's geoname -->
                        <tr class='active' ng-show='tabs.questionnaires.length'>
                            <td></td>
                            <td></td>
                            <td ng-if='tabs.selectedQuestionnaireForLabels' class='text-center'>{{tabs.selectedQuestionnaireForLabels.geoname.country.name}}</td>
                            <td ng-repeat='questionnaire in tabs.questionnaires track by $index'>
                                <div ng-switch="!!questionnaire.id">
                                    <div ng-switch-when="true" class='text-center'>
                                        <div name='questionnaireForm' class='input-group input-group-sm'>
                                            <div class='input-group-addon'><i class='fa fa-gims-questionnaire'></i></div>
                                            <input ng-disabled='true' type='text' class='text-center' placeholder='Country' ng-model='questionnaire.geoname.country.name' name='country' />
                                        </div>
                                    </div>
                                    <div ng-switch-when="false" class='has-error'>
                                        <ng-form name='questionnaireForm'>
                                            <gims-select
                                                disabled='questionnaire.id || questionnaire.isLoading'
                                                api="country" model='questionnaire.geoname.country'
                                                queryparams="countryParams"
                                                placeholder="Country"
                                                change-url = "false"
                                                style="width: 100%"
                                                ng-change='checkQuestionnairesIntegrity();completeQuestionnaire(questionnaire);'>
                                            </gims-select>
                                        </ng-form>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- Survey's code -->
                        <tr class='active' ng-show='tabs.questionnaires.length'>
                            <td></td>
                            <td></td>
                            <td ng-if='tabs.selectedQuestionnaireForLabels' class='text-center'>{{tabs.selectedQuestionnaireForLabels.survey.code}}</td>
                            <td ng-repeat='questionnaire in tabs.questionnaires track by $index' class='text-center'>
                                <ng-form name='questionnaireForm' class='input-group input-group-sm'>
                                    <div class='input-group-addon'><i class='fa fa-gims-survey'></i></div>
                                    <input ng-disabled='questionnaire.survey.id || questionnaire.isLoading' type='text' class='text-center' placeholder='Code' ng-model='questionnaire.survey.code' name='code' required ng-class="{'error':questionnaire.errors.duplicateCountryCode || questionnaire.errors.codeAndYearDifferent || questionnaireForm.code.$invalid}" ng-blur='checkQuestionnairesIntegrity();completeQuestionnaire(questionnaire);'/>
                                </ng-form>
                            </td>
                        </tr>

                        <!-- Survey's year -->
                        <tr class='active' ng-show='tabs.questionnaires.length'>
                            <td></td>
                            <td></td>
                            <td ng-if='tabs.selectedQuestionnaireForLabels' class='text-center'>{{tabs.selectedQuestionnaireForLabels.survey.year}}</td>
                            <td ng-repeat='questionnaire in tabs.questionnaires track by $index'>
                                <ng-form name='questionnaireForm' class='input-group input-group-sm'>
                                    <div class='input-group-addon'><i class='fa fa-gims-survey'></i></div>
                                    <input ng-disabled='questionnaire.survey.id || questionnaire.isLoading' type='number' class='text-center' placeholder='Year' ng-model='questionnaire.survey.year' name='year' min='1980' max='2015' size="4" required ng-class="{'error': questionnaire.errors.codeAndYearDifferent || questionnaireForm.year.$invalid}" ng-blur='checkQuestionnairesIntegrity();completeQuestionnaire(questionnaire);'/>
                               </ng-form>
                           </td>
                        </tr>

                    </tbody>
                    <!-- End of table header-->


                    <!-- Population row -->
<!--                    <tbody ng-show='sector'>-->
<!--                        <tr ng-show='tabs.filters && tabs.questionnaires.length'>-->
<!--                           <td></td>-->
<!--                           <td class='strong'>Population</td>-->
<!--                           <td ng-if='tabs.selectedQuestionnaireForLabels'></td>-->
<!--                           <td class='text-center' ng-repeat='questionnaire in tabs.questionnaires track by $index'>-->
<!--                               <ng-form name='valueForm' ng-class="{'has-error':valueForm.value.$invalid}">-->
<!--                                   <div class="input-group input-group-sm">-->
<!--                                       <span class="input-group-btn"></span>-->
<!--                                       <input  type='number'-->
<!--                                               min='0'-->
<!--                                               name='value'-->
<!--                                               ng-model='questionnaire.population'/>-->
<!--                                   </div>-->
<!--                               </ng-form>-->
<!--                           </td>-->
<!--                        </tr>-->
<!--                    </tbody>-->


                    <!-- Label for questionnaire comments and close btn -->
                    <tbody ng-if='tabs.selectedQuestionnaireForComments'>
                        <tr>
                            <td><a class='btn btn-default btn-xs' ng-click='tabs.selectedQuestionnaireForComments = null'><i class='fa fa-times'></i></a></td>
                            <td><i class='fa fa-comment'></i> Comments for {{tabs.selectedQuestionnaireForComments.geoname.country.name}}, {{tabs.selectedQuestionnaireForComments.survey.code}}, {{tabs.selectedQuestionnaireForComments.survey.year}}</td>

                            <td ng-attr-colspan="{{!tabs.selectedQuestionnaireForLabels && tabs.questionnaires.length || tabs.selectedQuestionnaireForLabels && (tabs.questionnaires.length+1)}}" ng-if='tabs.selectedQuestionnaireForComments' class='text-center'>

                                <ng-form name='labelForm' ng-if='mode != "Browse"'>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class='fa fa-comment'></i></span>
                                        <textarea class='form-control'
                                               ng-model="tabs.selectedQuestionnaireForComments.comments"
                                               ng-focus='tabs.selectedQuestionnaireForComments.initialComments = tabs.selectedQuestionnaireForComments.comments'
                                               ng-blur='saveComment(tabs.selectedQuestionnaireForComments)'
                                               name="label"></textarea>
                                    </div>
                                </ng-form>
                            </td>
                        </tr>
                    </tbody>

                    <tbody>
                        <!-- Filters and answers rows -->
                        <tr ng-repeat="filter in tabs.filters track by $index" ng-show='expandHierarchy || filter.level <= tabs.filters[0].level || sector' ng-class="{'active':sector && !filter.sectorChild}">

                            <!-- Remove Filter from selection -->
                            <td>
                                <div class='btn btn-default btn-xs' ng-click='removeFilter($index)' ng-show='!filter.sectorChild'><i class='fa fa-times'></i></div>
                            </td>

                            <!-- Filter name column-->
                            <td>
                                <div ng-show='isValidId(filter) || filter.sectorChild' ng-class="{'strong':filter.level == tabs.filters[0].level && !filter.sectorChild}" style='margin-left:{{filter.level - tabs.filters[0].level}}em;'>
                                    <i class='fa' style='color:{{filter.color}}' ng-class="{'text-muted':filter.sectorChild, 'fa-gims-filter':!filter.isLoading && !filter.sectorChild, 'fa-asterisk text-primary':!filter.isLoading && filter.sectorChild, 'fa-gims-loading':filter.isLoading}"></i>
                                    {{filter.name}}
                                    <a href='/admin/filter/edit/{{filter.id}}?returnUrl={{currentUrl}}' ng-show='mode != "Browse" && !filter.sectorChild'><i class='fa fa-pencil'></i></a>
                                </div>
                                <div ng-show='!isValidId(filter) && !filter.sectorChild'>
                                    <ng-form name='filterName' class="input-group" ng-class="{'has-error':filterName.$invalid}">
                                         <span class="input-group-btn">
                                            <button type="button" class="btn btn-default"><i class='fa' ng-class="{'fa-asterisk':!filter.isLoading,'fa-gims-loading':filter.isLoading,'text-primary':!filterName.$invalid, 'text-danger':filterName.$invalid}"></i></button>
                                         </span>
                                        <input type='text' name='name' ng-model='filter.name' placeholder='Filter name' required />
                                    </ng-form>
                                </div>
                            </td>

                            <!-- Questions labels column -->
                            <td ng-if='tabs.selectedQuestionnaireForLabels'>
                                <ng-form name='labelForm' ng-if='mode != "Browse"'>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-addon"><i class='fa fa-question'></i></span>
                                        <input class='form-control'
                                               ng-model="tabs.selectedQuestionnaireForLabels.survey.questions[filter.id].name"
                                               ng-focus='tabs.selectedQuestionnaireForLabels.survey.questions[filter.id].initialName = tabs.selectedQuestionnaireForLabels.survey.questions[filter.id].name'
                                               ng-blur='saveQuestion(tabs.selectedQuestionnaireForLabels.survey.questions[filter.id], tabs.selectedQuestionnaireForLabels.survey)'
                                               name="label"
                                               ng-required="tabs.selectedQuestionnaireForLabels.survey.questions[filter.id].answers[part.id][questionnaire.survey.questions[filter.id].value]"
                                               ng-class="{'error': labelForm.label.$invalid}"/>
                                    </div>
                                </ng-form>
                            </td>

                            <!-- Questionnaires columns -->
                            <td ng-repeat='questionnaire in tabs.questionnaires track by $index' >

                                <!-- Display answers / formulas in *browse* mode -->
                                <div class='text-center' ng-if='mode == "Browse" && !isLoading' >
                                    <div ng-if='toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value])'>
                                        <i ng-if='questionnaire.survey.questions[filter.id].name' class='fa fa-question fa-fw text-muted' tooltip='{{questionnaire.survey.questions[filter.id].name}}'></i>
                                        {{questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]|percent}} %
                                    </div>
                                    <div ng-if='!toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) && (questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first || questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second)'>
                                        <i class='fa fa-cog fa-fw text-muted'></i>
                                        <span ng-show='!toBoolNum(questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second) && toBoolNum(questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first)' class="text-lined-through" >{{questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first|percent}}</span>
                                        <span ng-show='toBoolNum(questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second)'>{{questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second|percent}}</span>
                                        %
                                    </div>
                                </div>

                                <!-- Display answers / formulas in *contribute* mode -->
                                <ng-form name='valueForm' ng-if='mode != "Browse" && !sector || sector && filter.sectorChild'>
                                    <div class="input-group input-group-sm">

                                        <!-- add-on buttons on input fields -->
                                         <span class="input-group-btn">
                                            <button type="button" class="btn btn-default dropdown-toggle"  data-toggle='dropdown-menu' ng-show='questionnaire.permissions.update || questionnaire.survey.questions[filter.id].name && toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) || questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second || questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first || questionnaire.survey.questions[filter.id].answers[tabs.part.id].isLoading'>
                                                <span ng-switch='!!questionnaire.survey.questions[filter.id].answers[tabs.part.id].isLoading'>
                                                    <span ng-switch-when="true">
                                                        <i class='fa fa-gims-loading fa-fw'></i>
                                                    </span>
                                                    <span ng-switch-when="false">
                                                        <i ng-if='questionnaire.permissions.update && !toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) && !questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first && !questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second' class='fa fa-angle-down fa-fw'></i>
                                                        <i ng-if='questionnaire.survey.questions[filter.id].name && toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value])' class='fa fa-question fa-fw'></i>
                                                        <i ng-if='!toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) && (questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second || questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first)'
                                                           class='fa fa-fw'
                                                           ng-class="{'fa-cog':!isComputing, 'fa-gims-loading':isComputing, 'text-danger':!questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second && questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first}"></i>
                                                    </span>
                                                </span>
                                            </button>

                                             <!-- drop down menu -->
                                            <ul class="dropdown-menu pull-right" ng-show='questionnaire.permissions.update || questionnaire.survey.questions[filter.id].name || questionnaire.survey.questions[filter.id].answers[tabs.part.id].id'>
                                                <li ng-if='questionnaire.survey.questions[filter.id].name || questionnaire.survey.questions[filter.id].answers[tabs.part.id].id' class="dropdown-header">
                                                    <i class='fa fa-info-circle fa-fw fa-lg'></i> Informations
                                                </li>
                                                <li ng-if='questionnaire.survey.questions[filter.id].name'>
                                                    <a><i class='fa fa-question fa-fw'></i> {{questionnaire.survey.questions[filter.id].name}}</a>
                                                </li>
                                                <!--<li ng-if='!toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) && toBoolNum(questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second)'><a><i class='fa fa-cog fa-fw'></i></a></li>-->

                                                <li ng-if='questionnaire.permissions.update && questionnaire.survey.questions[filter.id].name || questionnaire.survey.questions[filter.id].answers[tabs.part.id].id' class="divider" ></li>
                                                <li ng-if='questionnaire.permissions.update' class="dropdown-header"><i class='fa fa-bolt fa-fw fa-lg'></i> Actions</li>
                                                <li ng-if='questionnaire.permissions.update'>
                                                    <a href ng-click='toggleQuestionAbsolute(questionnaire, questionnaire.survey.questions[filter.id], filter)'><i class='fa fa-fw'>%</i>
                                                        Set question as
                                                        <span ng-if='questionnaire.survey.questions[filter.id].isAbsolute'>percent</span>
                                                        <span ng-if='!questionnaire.survey.questions[filter.id].isAbsolute'>absolute</span>
                                                        value
                                                    </a>
                                                </li>
                                                <li ng-if='questionnaire.survey.questions[filter.id].answers[tabs.part.id].id'>
                                                    <a href ng-click='removeAnswer(questionnaire.survey.questions[filter.id], questionnaire.survey.questions[filter.id].answers[tabs.part.id], questionnaire.permissions)'>
                                                        <span class='text-danger'><i class='fa fa-trash-o fa-fw'></i> Remove answer</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </span>

                                        <!-- input for edit answer -->
                                        <input ng-if='questionnaire.survey.questions[filter.id].value'
                                               class='form-control text-center'
                                               ng-class="{'error': valueForm.value.$invalid}"
                                               min='0'
                                               ng-max='questionnaire.survey.questions[filter.id].max'
                                               name='value'
                                               type='number'
                                               placeholder='{{questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].second || questionnaire.survey.questions[filter.id].filter.values[tabs.part.id].first}}'
                                               ng-focus='setInitialValue(questionnaire.survey.questions[filter.id], questionnaire, questionnaire.survey.questions[filter.id].answers[tabs.part.id]); getPermissions(questionnaire.survey.questions[filter.id], questionnaire.survey.questions[filter.id].answers[tabs.part.id])'
                                               ng-blur='saveAnswer(questionnaire.survey.questions[filter.id].answers[tabs.part.id], questionnaire.survey.questions[filter.id], filter, questionnaire, tabs.part)'
                                               ng-model='questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]'
                                               ng-disabled='questionnaire.survey.questions[filter.id].answers[tabs.part.id].permissions.update == false ||
                                                            !toBoolNum(questionnaire.survey.questions[filter.id].answers[tabs.part.id][questionnaire.survey.questions[filter.id].value]) && questionnaire.permissions.create === false ||
                                                            sector && questionnaire.id'
                                            />
                                    </div>
                                </ng-form>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </form>
        </div>
    </div>
</div>

<pre>
    {{tabs.questionnaires|json}}
</pre>